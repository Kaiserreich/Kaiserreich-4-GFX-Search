name: Generate GitHub Pages

on:
  push:
    branches:
    - master
    - gh-pages
    paths:
    - '.github/workflows/Generate GitHub Pages.yml'
    - '.github-pages/**/*'
    - '.gitignore'
    - 'images/**/*'
    - 'gfx/interface/texticons/**/*.dds'
    - 'gfx/interface/texticons/**/*.tga'
    - 'gfx/interface/event_pictures/**/*.dds'
    - 'gfx/interface/event_pictures/**/*.tga'
    - 'gfx/interface/event_news_pictures/**/*.dds'
    - 'gfx/interface/event_news_pictures/**/*.tga'
    - 'gfx/interface/decisions/**/*.dds'
    - 'gfx/interface/decisions/**/*.tga'
    - 'gfx/interface/decisions/category_pictures/*.dds'
    - 'gfx/interface/decisions/category_pictures/*.tga'
    - 'gfx/interface/goals/**/*.dds'
    - 'gfx/interface/ideas/**/*.dds'
    - 'gfx/interface/goals/**/*.tga'
    - 'gfx/interface/ideas/**/*.tga'
    - 'gfx/interface/operatives/agencies/**/*.dds'
    - 'gfx/interface/operatives/agencies/**/*.tga'
    - 'interface/**/*.gfx'
  repository_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Kaiserreich/Kaiserreich-4-Development master branch
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.GHPAGES_PUSH_TOKEN }}
        ref: master
        path: ''
        repository: 'Kaiserreich/Kaiserreich-4-Development'
    - name: Checkout master branch
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.GHPAGES_PUSH_TOKEN }}
        ref: master
        path: gh-pages
    - name: Set up Python 3.8
      uses: actions/setup-python@v1
      with:
        python-version: 3.8
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r $GITHUB_WORKSPACE/gh-pages/.github-pages/requirements.txt
    - name: Check modified files
      if: github.event_name == 'repository_dispatch'
      run: |
        MODIFIED_FILES="${{ github.event.client_payload.files }}" 
        export MODIFIED_FILES
        echo "::set-env name=MODIFIED_FILES::$MODIFIED_FILES"
        echo $MODIFIED_FILES
    - name: Generate webpage
      run: |
        cp -rf $GITHUB_WORKSPACE/gfx/ $GITHUB_WORKSPACE/gh-pages/
        cp -rf $GITHUB_WORKSPACE/interface $GITHUB_WORKSPACE/gh-pages
        cd $GITHUB_WORKSPACE/gh-pages
        python .github-pages/hoi4_icon_search_gen.py --goals "./interface/KR_goals.gfx" --ideas "./interface/KR_ideas.gfx" "./interface/KR_ideas_africa.gfx" "./interface/KR_ideas_americas.gfx" "./interface/KR_ideas_asia.gfx" "./interface/KR_ideas_europe.gfx" --texticons "./interface/KR_texticons.gfx" --events "./interface/KR_event_pictures.gfx" --news-events "./interface/KR_event_news_pictures.gfx" --agencies "./interface/KR_countryintelligenceagencyview.gfx"  --decisions "./interface/KR_decisions.gfx" --decisions-cat "./interface/KR_decisions_categories.gfx" --decisions-pics "./interface/KR_decisions_categories_pictures.gfx" --title "Kaiserreich GFX Search" --favicon "./kr_icon.png" --modified-images-str "$MODIFIED_FILES"
    - name: Commit and push files
      run: |
        cd $GITHUB_WORKSPACE/gh-pages
        if [ -z "$(git status --porcelain)" ]; then 
          exit 0
        fi
        PYDATE=$(python -c "import datetime; print(datetime.datetime.utcnow())")
        sed -i "s/@UPDATE_DATE/${PYDATE}/g" index.html
        git config --global user.email "antoni.baum@protonmail.com"
        git config --global user.name "Yard1"
        git pull
        git pull
        git add -A
        git commit -m "Update webpage (automatic)"
        git push
